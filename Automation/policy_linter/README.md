# LaunchDarkly Policy Linter
A CLI tool for validating, exporting, and fixing LaunchDarkly custom roles to ensure they use only valid actions and follow best practices.

## Key Features

* Validate Policies: Automatically check custom role  against LaunchDarkly's official resource actions
* Identify Issues: Find and flag invalid, deprecated, or potentially problematic actions
* Auto-Fix Capability: Generate corrected versions of policies with invalid actions removed
* Bulk Export: Export all policies for backup, audit, or migration purposes


## Who Should Use This?

* LaunchDarkly Administrators: Managing multiple custom roles across your organization
* DevOps Teams: Ensuring role-based access control follows security best practices
* Security Teams: Auditing and remediating access control issues
* Platform Migrations: Moving policies between LaunchDarkly accounts.


## Installation

### Prerequisites

- Python 3.6 or higher
- LaunchDarkly API key with appropriate permissions:
  - **Read-only** permission for export and validation
  - **updatePolicy** permission for applying patches

## Quick Start

```bash
# Install
git clone <repository-url>
cd policy-linter
./setup.sh
source venv/bin/activate

# Add your API key
echo "LAUNCHDARKLY_API_KEY=api-xxxx" > .env

# Validate policies
policy-linter --validate

# Fix invalid policies
policy-linter --fix
```
To disable/exit-from virtual environment
```bash
deactivate
```

## Usage

### Exporting Policies

Export all custom role policies from your LaunchDarkly account:

```bash
policy-linter --export
```


This will:
1. Export policies if they haven't been exported yet
2. Check each policy against valid resource actions
3. Generate a report of invalid actions in `./output/reports/invalid_actions.json`.
> Invalid actions includes resource and/or actions that have been deprecated.

### Fixing Invalid Policies

Generate fixed versions of policies with invalid actions removed:

```bash
policy-linter --fix
```



This will:
1. Read the invalid actions report
2. Create fixed versions of policies with invalid actions removed
3. Save the fixed policies to `./output/modified-roles`
4. Generate a restricted custom role file (`custom-role.role`) in the `./output/patches/` directory that allows updating only the policies that had invalid actions

### Applying Patches to Policies

After generating patches with the `--fix` command, you can apply them to your LaunchDarkly custom roles using the `--apply-patch` option. This will update the actual policies in your LaunchDarkly account:

> ⚠️ **WARNING**: The `--apply-patch` command will make LIVE changes to your custom roles in LaunchDarkly. Always review the corresponding `.patched` file before applying any patches to understand exactly what will be modified. These changes affect permissions in your production environment and could impact user access if not properly reviewed.

```bash
policy-linter --apply-patch ./output/patches/sample-deprecated-role.patch
```


This command:
1. Prompts for confirmation before making any changes
2. Applies the JSON patch operations to remove invalid actions
3. Updates the policy in LaunchDarkly using the API
4. Displays the updated policy details

The interactive confirmation prompt helps prevent accidental changes and gives you a chance to review the policy that will be modified.

### Rolling Back Changes with Reverse Patches

If you need to revert changes made by applying a patch, you can use the `--reverse-patch` option with the corresponding reverse patch file:

> ⚠️ **WARNING**: The `--reverse-patch` command will make LIVE changes to your custom roles in LaunchDarkly, reverting them to their previous state. While this is designed to restore policies to their original configuration, always verify that this is your intended action, as it will undo all the fixes applied by the patch.

```bash
policy-linter --reverse-patch ./output/patches/sample-deprecated-role.reverse-patch
```

This command:
1. Prompts for confirmation before making any changes
2. Applies the reverse JSON patch operations to restore the original policy state
3. Updates the policy in LaunchDarkly using the API
4. Displays the restored policy details

Using the reverse patch option provides a safety mechanism to restore policies to their original state if changes need to be rolled back.

> **Important:** Before applying either patches or reverse patches, make sure you're using an API key with the appropriate permissions. For security best practices, use the limited custom role generated by the tool (`custom-role.role`) to create a service token with only the necessary permissions.

## Command Line Options

```
usage: policy-linter [-h] [--apply-patch APPLY_PATCH_FILE]
                     [--reverse-patch APPLY_REVERSE_PATCH_FILE]
                     [--validate] [--export] [--debug] [--log-file LOG_FILE]
                     [--resource_actions RESOURCE_ACTIONS] [--fix]

Policy Linter CLI tool

optional arguments:
  -h, --help            show this help message and exit
  --apply-patch APPLY_PATCH_FILE, -ap APPLY_PATCH_FILE
                        Apply a patch file to a policy
  --reverse-patch APPLY_REVERSE_PATCH_FILE, -arp APPLY_REVERSE_PATCH_FILE
                        Apply a reverse patch file to a policy
  --validate, -v        Validate policies and generate a report of invalid actions in a json file
  --export, -e          Export policies to individual files
  --debug               Enable debug logging
  --log-file LOG_FILE   Write logs to specified file in addition to console
  --resource_actions RESOURCE_ACTIONS
                        Path to resource actions file (default: config/resource_actions.json)
  --fix, -f             Fix invalid policies by removing invalid actions based on invalid_actions.json
```

## Project Structure

- `api_client/`: Client for interacting with the LaunchDarkly API
- `policy_linter/`: Core linting functionality
- `shadow_doc/`: Tool for extracting resource actions from LaunchDarkly documentation
- `config/`: Configuration files including resource actions schema
- `output/`: Default output directory for exports and reports which includes the following subdirectories
   * `./reports`: Directory contains `invalid_actions.json`, which lists invalid actions found in a policy file. To generate this file run with `--validate` or `-v`.
   * `./exported_roles`: Includes all custom roles exported from the account. To export run with `--export` or `-e`.
   * `./patches`: Contains patch files and the `custom-role.role` file. The latter is a special custom role that grants permissions to update only the policies that had invalid actions. This limited role provides a secure way to apply fixes without granting broader permissions.

## Custom Role for Policy Updates

When running the `--fix` command, the tool generates a `custom-role.role` file in the `output/patches` directory. This file defines a custom role with the following characteristics:

- Key: `limited-update-policy-role`
- Limited Scope: Only grants the `updatePolicy` action on the specific policies that contained invalid actions
- Security Benefit: Provides least-privilege access for applying fixes
- Purpose: The policy (section) is to be used for generating a scoped service token for updating only the policies with invalid actions.

This approach follows security best practices by providing a role with minimal permissions required to complete the policy update task, rather than requiring broad administrative access.

## Common Workflow

1. Update the resource actions schema:
   LaunchDarkly periodically updates their available actions when they release new features.  See `./config/resource_actions.json`
2. Export and validate policies:
   ```bash
   policy-linter --validate
   ```
   or
   ```bash
   % policy-linter --export
   % policy-linter --validate
   ```


3. Review the invalid actions report at `./output/reports/invalid_actions.json`

4. Generate fixed policies:
   ```bash
   policy-linter --fix
   ```

5. Review the patched policies in `./output/patches/<policy_key>.patched`

6. Create a custom role in LaunchDarkly using policy section of the generated `custom-role.role`. See [Creating custom roles and policies](https://launchdarkly.com/docs/home/account/role-create) for details.
For example:
```json
{
  "key": "limited-update-policy-role",
  "type": "custom-role",
  "created_at": "2025-04-10 14:13:06",
  "policy": [   
    {
      "resources": [
        "developer-role",
        "release-manager-role"
      ],
      "actions": [
        "updatePolicy"
      ],
      "effect": "allow"
    
    }]
}
```
Copy and paste the policy section of custom-role.role to the LaunchDarkly [Advanced Editor](https://launchdarkly.com/docs/home/account/advanced-editor):

```json


[   
    {
      "resources": [
        "developer-role",
        "release-manager-role"
      ],
      "actions": [
        "updatePolicy"
      ],
      "effect": "allow"
    
    }]
```

7. Create a service token and assign it the role from the previous step. See [Create access tokens](https://launchdarkly.com/docs/home/account/api-create#create-access-tokens) for details.

8. Update `LAUNCHDARKLY_API_KEY` in `.env` file with the service token you've generated in the previous step.

9. Apply patches using the command:

```bash
policy-linter --apply-patch ./output/patches/developer-role.patch
```

10. If necessary, you can revert changes by applying the reverse patch:

```bash
policy-linter --reverse-patch ./output/patches/developer-role.reverse-patch
```

## Patch files Details

Patch files are generated when you run the `--fix` command and contain the changes needed to fix invalid actions in your LaunchDarkly custom role policies. The tool creates three types of files for each policy that needs fixing:

1. **Patch File (.patch)**: Contains the JSON patch operations needed to fix the policy by removing invalid actions. This is what gets applied when using `--apply-patch`.

Example of a patch file structure:
```json
{
  "key": "sample-also-deprecated-role",
  "type": "patch",
  "created_at": "2025-04-10 17:07:45",
  "patch": [
    {
      "op": "replace",
      "path": "/policy/0/resources/0",
      "value": "member/*"
    },
    {
      "op": "replace",
      "path": "/policy/0/actions/0",
      "value": "deleteMember"
    },
    {
      "op": "replace",
      "path": "/policy/1/actions/0",
      "value": "deleteMember"
    }
    ...
  ]
}
```

2. **Patched File (.patched)**: Contains the complete fixed policy with invalid actions removed. This is for valition, the remote policy (in LaunchDarkly) and the local policy should be identical. *STOP* and review the patch file if they are not.

Example of a patched policy:
```json
{
  "_id": "67f029da9d331109a320f9a3",
  "_links": {
    "parent": {
      "href": "/api/v2/roles",
      "type": "application/json"
    },
    "self": {
      "href": "/api/v2/roles/sample-also-deprecated-role",
      "type": "application/json"
    }
  },
  "description": "",
  "key": "sample-also-deprecated-role",
  "name": "sample-also-deprecated-role",
  "policy": [
    {
      "resources": [
        "member/*"
      ],
      "actions": [
        "deleteMember"
      ],
      "effect": "allow"
    },
    {
      "resources": [
        "member/*"
      ],
      "actions": [
        "deleteMember"
      ],
      "effect": "allow"
    }
  ],
  "basePermissions": "no_access"
}
```
3. **Reverse Patch File (.reverse-patch)**: Contains the JSON patch operations to revert the changes made by the patch file. This is used when you need to roll back changes with `--reverse-patch`.

Example of reverse patch file structure:
```json
{
  "key": "sample-also-deprecated-role",
  "type": "reverse-patch",
  "created_at": "2025-04-10 17:07:45",
  "patch": [
    {
      "op": "replace",
      "path": "/policy/0/resources/0",
      "value": "proj/*:env/*:flag/*"
    },
    {
      "op": "replace",
      "path": "/policy/0/actions/0",
      "value": "deleteUser"
    },
    {
      "op": "replace",
      "path": "/policy/1/actions/0",
      "value": "deleteUser"
    }
    ...
  ]
}

```

## Important Notes

* Empty Policies: 
If a policy fix leads to no remaining statements, the tool will issue a warning and refrain from creating a path file. 

* API Key Permissions:
   - Use Reader permissions when exporting and validating custom roles.
   - Use a limited/restricted token with `updatePolicy` action only. Ensure to list only the custom roles that will be modified in the resource list. See creating custom role from previous topic details.


* Custom Role Limits: LaunchDarkly allows 1,000 custom roles per account by default. See [Creating custom roles and Policies](https://launchdarkly.com/docs/home/account/role-create).

* October 2024 Changes: LaunchDarkly changed default custom role behavior (previously had Reader permissions by default, now has no access by default)

* Deprecated User Resource Type:
   - If an invalid or deprecated resource type like `user` is detected in your policies, the tool will generate a WARNING and will not create patch files for those policies.
   - The User resource is only relevant when working with older SDKs that don't support contexts.
   - If you are working with older SDKs which do not yet support contexts, you can reference the user resource, which is scoped to a project and environment. It has one action, `deleteUser`, which allows deleting context instances.
   - For SDKs that have been updated for contexts, the equivalent action is `deleteContextInstance`, which is scoped to the environment resource.
   - LaunchDarkly strongly encourages upgrading SDKs to versions supporting contexts for better functionality and compatibility.
   
   Example of a policy with deprecated user resource that will generate a warning:
   ```json
   {
     "resources": [
       "proj/*:env/*:user/*"
     ],
     "actions": [
       "deleteUser"
     ],
     "effect": "allow"
   }
   ```
   
   Recommended modern equivalent using environment resource:
   ```json
   {
     "resources": [
       "proj/*:env/*"
     ],
     "actions": [
       "deleteContextInstance"
     ],
     "effect": "allow"
   }
   ```

## License
See the LICENSE file for details.
